<h3>Bienvenue sur l'interface de consultation des stages effectués à l'UTC.</h3>
<p>Vous pouvez utiliser les filtres mis à votre disposition pour rechercher des stages correspondant à votre profil.</p>

<div class="row">
  <div class="col-md-9">
    <table class="table table-condensed table-hover ">
      <thead>
      <tr>
        <th>Semestre</th>
        <th>Sujet</th>
        <th>Entreprise</th>
        <th>Ville</th>
        <th>Pays</th>
      </tr>
      </thead>
      <tr>
        <td></td>
        <td><input type="text" class="form-control subject" placeholder="Sujet" autocomplete="off"/></td>
        <td><input type="text" class="form-control company" placeholder="Entreprise" autocomplete="off"/></td>
        <td><input type="text" class="form-control city" placeholder="Ville" autocomplete="off"/></td>
        <td><input type="text" class="form-control country" placeholder="Pays" autocomplete="off"/></td>
      </tr>
      <% @internships.each do |internship| %>
          <tr internship-id="<%= internship.id %>">
            <!-- Different color for spring and autumn semesters -->
            <td <% if internship.semester == 'A' %>class="text-success"<% end %>><%= internship.semester %><%= internship.year %></td>
            <td class="subject"><a href="application/<%= internship.id %>"><%= internship.subject %></a></td>
            <td class="company"><%= internship.company %></td>
            <td class="city">Villeville</td>
            <td class="country"><%= internship.country %></td>
          </tr>
      <% end %>
    </table>
  </div>

  <div class="col-md-3 hidden-sm" id="panel-container">
    <div class="panel panel-success" data-spy="affix" data-offset-top="80" id="internship-info">
      <div class="panel-heading">
        <h3 class="panel-title">Sujet</h3>
      </div>
      <div class="panel-body">
        Description du stage
      </div>
  </div>
</div>

<script type="text/javascript">
$(document).ready(function() {
    var $internshipInfoPanel = $('#internship-info');

    function resizeInternshipPanelInformation() {
        $internshipInfoPanel.width($internshipInfoPanel.parent().width());
    }

    //Setting panel size when page is loaded.
    resizeInternshipPanelInformation()

    //Resizing panel width when size of the window changes.
    $(window).resize(function () {
        resizeInternshipPanelInformation();
    });

    $('tr[internship-id]').click(function(){
        var id = $(this).attr('internship-id');

        //Retrieving data of the clicked row
        $.ajax({
            url: "/internships/" + id,
            type: "GET",
            dataType: "json"
        }).done(function(data){
            $internshipInfoPanel.find('.panel-title').text(data.subject)
            updateInfoPanelContents(data);
        });
    });

    /*
    Update contents of internship information panel based on information retrieved from server.
     */
    function updateInfoPanelContents(data){
        $internshipInfoPanel.find('.panel-body').html(data.description)
    }

    $rows = $('table tr[internship-id]');

    // When row is click: highlight it. Other rows should not be highlighted.
    $rows.on('click', function(event) {
        $(this).addClass('success').siblings().removeClass('success');
    });

    $filters = $('table input');

    $filters.on("focusout", function () {
        filterTable()
    });

    $filters.on("keyup", function (e) {
        //If user pressed enter key: remove focus, which triggers table filter.
        if (e.keyCode == 13) {
            $(this).blur();
        }
    });

    function filterTable() {
        //Determine which filtered contain text entered by user to filter table.
        var $filtersUsed = $filters.filter(function () {
            return $.trim(this.value).length > 0;
        });

        //If user did not input anything, or if field is blank (spaces), return and show everything.
        if ($filtersUsed.length === 0)
            return $rows.show();

        //Getting class of the filters used by the user.
        var $filterClass = '.' + $filtersUsed.map(function () {
                    return this.className.split(' ')[1];
                }).get().join(',.');

        //Filtering table. Only filtering td with class that should be filtered.
        $rows.hide().filter(function () {
            return $('td', this).filter($filterClass).filter(function () {
                        var content = this.textContent.toLowerCase();
                        var inputVal = $filtersUsed.filter('.' + this.className).val().toLowerCase();

                        return content.indexOf(inputVal) > -1;

                    }).length === $filtersUsed.length;
        }).show();
    }
});
</script>